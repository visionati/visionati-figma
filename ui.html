<!DOCTYPE html>
<html>
<head>
<style>
  :root {
    --spacing: 8px;
    --spacing-sm: 4px;
    --spacing-lg: 12px;
    --spacing-xl: 16px;
    --radius: 6px;
    --radius-sm: 4px;
    --font-size-xs: 11px;
    --font-size-sm: 12px;
    --font-size-base: 13px;
    --font-size-lg: 14px;
    --transition: 150ms ease;
    --visionati-orange: #fb7300;
    --visionati-orange-hover: #e06800;
    --color-alt-text: #2ecc71;
    --color-caption: #3498db;
    --color-description: #9b59b6;
    --color-applied: #27ae60;
    --color-error: #e74c3c;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    font-family: 'Inter', 'Figma Sans', system-ui, -apple-system, BlinkMacSystemFont,
      'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    font-size: var(--font-size-base);
    background-color: var(--figma-color-bg);
    color: var(--figma-color-text);
    overflow: hidden;
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--figma-color-border); border-radius: 3px; }

  /* ===== Shell ===== */

  #plugin-container {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* ===== Tabs ===== */

  #tabs {
    display: flex;
    border-bottom: 1px solid var(--figma-color-border);
    flex-shrink: 0;
  }

  .tab {
    flex: 1;
    padding: 9px var(--spacing);
    text-align: center;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--figma-color-text-secondary);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: color var(--transition), border-color var(--transition);
  }
  .tab:hover { color: var(--figma-color-text); }
  .tab.active {
    color: var(--figma-color-text);
    border-bottom-color: var(--visionati-orange);
  }

  .tab-panel {
    display: none;
    flex: 1;
    min-height: 0;
    flex-direction: column;
  }
  .tab-panel.active { display: flex; }

  /* ===== Generate Tab: sticky controls + scrollable results ===== */

  #generate-controls {
    flex-shrink: 0;
    padding: var(--spacing-lg) var(--spacing-xl) var(--spacing);
    display: flex;
    flex-direction: column;
    gap: var(--spacing);
    border-bottom: 1px solid var(--figma-color-border);
  }

  #generate-scroll {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-lg) var(--spacing-xl);
  }

  /* ===== Error banner ===== */

  .error-banner {
    display: none;
    padding: var(--spacing) var(--spacing-lg);
    background-color: rgba(231, 76, 60, 0.1);
    border: 1px solid rgba(231, 76, 60, 0.3);
    border-radius: var(--radius-sm);
    color: var(--color-error);
    font-size: var(--font-size-sm);
    line-height: 1.4;
    word-break: break-word;
  }
  .error-banner.visible { display: block; }
  .error-banner div + div { margin-top: 4px; }
  .error-banner .dismiss {
    float: right;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    padding: 0 0 0 8px;
    opacity: 0.7;
  }
  .error-banner .dismiss:hover { opacity: 1; }

  /* ===== Field pills (compact horizontal) ===== */

  .field-pills {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .field-pill {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: var(--font-size-xs);
    font-weight: 500;
    cursor: pointer;
    border: 1.5px solid var(--figma-color-border);
    background: none;
    color: var(--figma-color-text-secondary);
    transition: all var(--transition);
    user-select: none;
  }
  .field-pill:hover { border-color: var(--figma-color-text-secondary); }

  .field-pill input { display: none; }

  .field-pill .pill-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    transition: opacity var(--transition);
    opacity: 0.4;
  }
  .field-pill.checked .pill-dot { opacity: 1; }

  .field-pill.checked {
    color: var(--figma-color-text);
    font-weight: 600;
  }

  .field-pill.checked.alt-text { border-color: var(--color-alt-text); background: rgba(46,204,113,0.08); }
  .field-pill.checked.caption { border-color: var(--color-caption); background: rgba(52,152,219,0.08); }
  .field-pill.checked.description { border-color: var(--color-description); background: rgba(155,89,182,0.08); }

  .pill-dot.alt-text { background: var(--color-alt-text); }
  .pill-dot.caption { background: var(--color-caption); }
  .pill-dot.description { background: var(--color-description); }

  /* ===== Action row ===== */

  .controls-row {
    display: flex;
    gap: var(--spacing);
    align-items: center;
  }



  /* ===== Buttons ===== */

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 7px var(--spacing-lg);
    font-family: inherit;
    font-size: var(--font-size-sm);
    font-weight: 600;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background-color var(--transition), opacity var(--transition);
    white-space: nowrap;
  }
  .btn:disabled { opacity: 0.45; cursor: not-allowed; }

  .btn-primary { background-color: var(--visionati-orange); color: #fff; }
  .btn-primary:hover:not(:disabled) { background-color: var(--visionati-orange-hover); }

  .btn-brand { background-color: var(--figma-color-bg-brand); color: var(--figma-color-text-onbrand); }
  .btn-brand:hover:not(:disabled) { opacity: 0.9; }

  .btn-secondary {
    background-color: var(--figma-color-bg-secondary);
    color: var(--figma-color-text);
    border: 1px solid var(--figma-color-border);
  }
  .btn-secondary:hover:not(:disabled) { background-color: var(--figma-color-border); }

  .btn-sm { padding: 4px var(--spacing); font-size: var(--font-size-xs); }

  .btn-text {
    background: none;
    border: none;
    color: var(--figma-color-text-secondary);
    font-size: var(--font-size-xs);
    cursor: pointer;
    padding: 3px 5px;
    border-radius: var(--radius-sm);
  }
  .btn-text:hover { color: var(--figma-color-text); background: var(--figma-color-bg-secondary); }
  .btn-text.danger:hover { color: var(--color-error); background: rgba(231,76,60,0.08); }

  .generate-buttons {
    display: flex;
    gap: var(--spacing);
    flex: 1;
  }
  .generate-buttons .btn { flex: 1; }

  /* ===== Selection annotations (read-back) ===== */

  #selection-annotations { display: none; }
  #selection-annotations.visible {
    display: flex;
    flex-direction: column;
    gap: var(--spacing);
    margin-bottom: var(--spacing-lg);
  }

  .sel-ann-header {
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--figma-color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .sel-ann-node {
    border: 1px solid var(--figma-color-border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  .sel-ann-node-name {
    font-size: var(--font-size-xs);
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    min-width: 0;
  }

  .sel-ann-entry {
    padding: var(--spacing) var(--spacing-lg);
    border-bottom: 1px solid var(--figma-color-border);
    display: flex;
    gap: var(--spacing);
    align-items: flex-start;
  }
  .sel-ann-entry:last-child { border-bottom: none; }

  .sel-ann-content { flex: 1; min-width: 0; }

  .sel-ann-text {
    cursor: text;
    border-radius: var(--radius-sm);
    padding: 2px 4px;
    margin: 0 -4px;
    transition: background-color var(--transition);
  }
  .sel-ann-text:hover { background-color: var(--figma-color-bg-secondary); }

  .sel-ann-edit-area { display: none; }
  .sel-ann-entry.editing .sel-ann-text { display: none; }
  .sel-ann-entry.editing .sel-ann-edit-area { display: block; }

  .sel-ann-edit-textarea {
    width: 100%;
    min-height: 50px;
    font-family: inherit;
    font-size: var(--font-size-xs);
    line-height: 1.5;
    color: var(--figma-color-text);
    background-color: var(--figma-color-bg-secondary);
    border: 1px solid var(--figma-color-border);
    border-radius: var(--radius-sm);
    outline: none;
    padding: 4px 6px;
    resize: vertical;
    margin-top: 4px;
  }
  .sel-ann-edit-textarea:focus { border-color: var(--figma-color-border-selected); }

  .sel-ann-edit-actions {
    display: flex;
    gap: 4px;
    margin-top: 4px;
  }

  .sel-ann-remove {
    flex-shrink: 0;
    background: none;
    border: none;
    color: var(--figma-color-text-secondary);
    font-size: 14px;
    cursor: pointer;
    padding: 0 2px;
    line-height: 1;
    opacity: 0.5;
    transition: opacity var(--transition), color var(--transition);
  }
  .sel-ann-remove:hover { opacity: 1; color: var(--color-error); }

  .sel-ann-node-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px var(--spacing-lg);
    background-color: var(--figma-color-bg-secondary);
    border-bottom: 1px solid var(--figma-color-border);
  }

  .sel-ann-label {
    font-size: 10px;
    font-weight: 700;
    padding: 1px 7px;
    border-radius: 3px;
    display: inline-block;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    background-color: var(--figma-color-bg-secondary);
    color: var(--figma-color-text-secondary);
  }
  .sel-ann-label.cat-alt-text { background-color: rgba(46,204,113,0.15); color: #27ae60; }
  .sel-ann-label.cat-caption { background-color: rgba(52,152,219,0.15); color: #2980b9; }
  .sel-ann-label.cat-description { background-color: rgba(155,89,182,0.15); color: #8e44ad; }

  .sel-ann-text {
    font-size: var(--font-size-xs);
    line-height: 1.5;
    color: var(--figma-color-text);
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* ===== Results area ===== */

  #results-area { display: none; }
  #results-area.visible { display: flex; flex-direction: column; gap: var(--spacing-lg); }

  .results-apply-all {
    display: flex;
    align-items: center;
    gap: var(--spacing-lg);
  }

  .results-apply-all .btn { flex: 1; }

  .results-apply-all .summary {
    font-size: var(--font-size-xs);
    color: var(--figma-color-text-secondary);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .results-apply-all .summary strong {
    color: var(--figma-color-text);
    font-weight: 600;
  }

  /* ===== Idle message (when no results yet) ===== */

  #idle-message {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 32px var(--spacing-xl);
    flex: 1;
  }

  #idle-message p {
    font-size: var(--font-size-sm);
    color: var(--figma-color-text-secondary);
    line-height: 1.5;
    max-width: 240px;
  }

  /* ===== Node card ===== */

  .node-card {
    border: 1px solid var(--figma-color-border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: border-color var(--transition);
  }
  .node-card.all-applied { border-color: var(--color-applied); }

  .node-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px var(--spacing-lg);
    background-color: var(--figma-color-bg-secondary);
    border-bottom: 1px solid var(--figma-color-border);
    gap: var(--spacing);
    min-height: 32px;
  }

  .node-thumb {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    object-fit: cover;
    flex-shrink: 0;
    border: 1px solid var(--figma-color-border);
    background-color: var(--figma-color-bg);
  }

  .node-card-header .node-name {
    font-size: var(--font-size-sm);
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    min-width: 0;
  }

  .node-card-header .node-actions {
    display: flex;
    gap: 4px;
    align-items: center;
    flex-shrink: 0;
  }

  .node-card-body { display: flex; flex-direction: column; }

  /* ===== Field entry ===== */

  .field-entry {
    padding: var(--spacing) var(--spacing-lg) var(--spacing-lg);
    border-bottom: 1px solid var(--figma-color-border);
    transition: opacity var(--transition);
  }
  .field-entry:last-child { border-bottom: none; }
  .field-entry.applied { opacity: 0.5; }

  .field-entry-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
  }

  .field-badge {
    font-size: 10px;
    font-weight: 700;
    padding: 1px 7px;
    border-radius: 3px;
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  .field-badge.alt-text { background-color: rgba(46,204,113,0.15); color: #27ae60; }
  .field-badge.caption { background-color: rgba(52,152,219,0.15); color: #2980b9; }
  .field-badge.description { background-color: rgba(155,89,182,0.15); color: #8e44ad; }

  .field-entry-header .backend-label {
    font-size: var(--font-size-xs);
    color: var(--figma-color-text-secondary);
    margin-left: auto;
  }

  .field-entry-header .applied-badge {
    font-size: var(--font-size-xs);
    padding: 1px 6px;
    border-radius: 3px;
    background-color: rgba(46,204,113,0.15);
    color: var(--color-applied);
    font-weight: 600;
    margin-left: auto;
  }

  .field-description-text {
    font-size: var(--font-size-sm);
    line-height: 1.55;
    color: var(--figma-color-text);
    white-space: pre-wrap;
    word-break: break-word;
    cursor: text;
    border-radius: var(--radius-sm);
    padding: 4px 6px;
    margin: 0 -6px;
    transition: background-color var(--transition);
  }
  .field-description-text:hover {
    background-color: var(--figma-color-bg-secondary);
  }
  .field-entry.applied .field-description-text {
    cursor: default;
  }
  .field-entry.applied .field-description-text:hover {
    background: none;
  }

  .field-edit-textarea {
    display: none;
    width: 100%;
    min-height: 60px;
    font-family: inherit;
    font-size: var(--font-size-sm);
    line-height: 1.5;
    color: var(--figma-color-text);
    background-color: var(--figma-color-bg-secondary);
    border: 1px solid var(--figma-color-border);
    border-radius: var(--radius-sm);
    outline: none;
    padding: 6px var(--spacing);
    resize: vertical;
  }
  .field-edit-textarea:focus { border-color: var(--figma-color-border-selected); }

  .field-entry.editing .field-description-text { display: none; }
  .field-entry.editing .field-edit-textarea { display: block; }

  .field-actions {
    display: flex;
    gap: 4px;
    align-items: center;
    margin-top: 6px;
  }
  .field-actions .spacer { flex: 1; }

  .field-entry.applied .field-actions .btn,
  .field-entry.applied .field-actions .btn-text { display: none; }

  /* ===== Settings tab ===== */

  .settings-scroll {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-xl);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  .field-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .field-group label {
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--figma-color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .field-group .hint {
    font-size: var(--font-size-xs);
    color: var(--figma-color-text-tertiary, var(--figma-color-text-secondary));
    font-weight: 400;
    text-transform: none;
    letter-spacing: normal;
    margin-top: -2px;
  }

  input[type="password"],
  input[type="text"],
  select,
  textarea {
    width: 100%;
    padding: 7px var(--spacing);
    font-family: inherit;
    font-size: var(--font-size-base);
    color: var(--figma-color-text);
    background-color: var(--figma-color-bg-secondary);
    border: 1px solid var(--figma-color-border);
    border-radius: var(--radius-sm);
    outline: none;
    transition: border-color var(--transition);
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--figma-color-border-selected);
  }

  textarea.settings-textarea {
    resize: vertical;
    min-height: 60px;
    font-size: var(--font-size-sm);
    line-height: 1.5;
  }

  select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='8' height='5' viewBox='0 0 8 5' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0.5 0.5L4 4L7.5 0.5' stroke='%23999' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    padding-right: 24px;
  }

  .key-status {
    font-size: var(--font-size-xs);
    padding: 2px 0;
  }
  .key-status.valid { color: #27ae60; }
  .key-status.invalid { color: var(--color-error); }

  /* First-run banner in settings */
  .first-run-banner {
    display: none;
    padding: var(--spacing) var(--spacing-lg);
    background: rgba(251, 115, 0, 0.08);
    border: 1px solid rgba(251, 115, 0, 0.25);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    color: var(--figma-color-text);
    line-height: 1.4;
  }
  .first-run-banner.visible { display: block; }

  /* ===== Progress bar ===== */

  .progress-bar-container {
    display: none;
    flex-shrink: 0;
    padding: 0 var(--spacing-xl) var(--spacing-sm);
  }
  .progress-bar-container.visible { display: block; }

  .progress-bar {
    width: 100%;
    height: 3px;
    background-color: var(--figma-color-border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background-color: var(--visionati-orange);
    border-radius: 2px;
    transition: width 300ms ease;
    width: 0%;
  }

  /* ===== Status bar ===== */

  #status-bar {
    flex-shrink: 0;
    padding: 5px var(--spacing-xl);
    font-size: var(--font-size-xs);
    color: var(--figma-color-text-secondary);
    border-top: 1px solid var(--figma-color-border);
    min-height: 26px;
    display: flex;
    align-items: center;
    gap: var(--spacing);
    background-color: var(--figma-color-bg);
  }

  #status-bar .spinner {
    display: none;
    width: 11px;
    height: 11px;
    border: 1.5px solid var(--figma-color-border);
    border-top-color: var(--visionati-orange);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    flex-shrink: 0;
  }
  #status-bar.loading .spinner { display: block; }

  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body></body>
  <div id="plugin-container">
    <!-- ===== Tabs ===== -->
    <div id="tabs">
      <button class="tab active" data-tab="generate">Generate</button>
      <button class="tab" data-tab="settings">Settings</button>
    </div>

    <!-- ===== Generate Tab ===== -->
    <div id="tab-generate" class="tab-panel active">
      <!-- Sticky controls -->
      <div id="generate-controls">
        <div id="error-banner" class="error-banner">
          <button class="dismiss" onclick="dismissError()">&times;</button>
          <span id="error-message"></span>
        </div>

        <!-- Field pills -->
        <div class="field-pills">
          <label class="field-pill checked alt-text" id="pill-alt-text">
            <input type="checkbox" id="field-alt-text" checked>
            <span class="pill-dot alt-text"></span>
            Alt Text
          </label>
          <label class="field-pill caption" id="pill-caption">
            <input type="checkbox" id="field-caption">
            <span class="pill-dot caption"></span>
            Caption
          </label>
          <label class="field-pill description" id="pill-description">
            <input type="checkbox" id="field-description">
            <span class="pill-dot description"></span>
            Description
          </label>
        </div>

        <!-- Action row -->
        <div class="controls-row">
          <div class="generate-buttons">
            <button class="btn btn-primary" id="btn-generate-selection" onclick="handleGenerate('selection')">
              &#x2726; Selection
            </button>
            <button class="btn btn-brand" id="btn-generate-page" onclick="handleGenerate('page')">
              &#x2B21; Scan Page
            </button>
          </div>

        </div>
      </div>

      <!-- Scrollable results -->
      <div id="generate-scroll">
        <!-- Annotations read-back from selection -->
        <div id="selection-annotations">
          <div class="sel-ann-header">Current Annotations</div>
          <div id="sel-ann-list"></div>
        </div>

        <div id="idle-message">
          <p>Select image layers and click Selection, or scan the entire page.</p>
        </div>

        <div id="results-area">
          <div class="sel-ann-header">Generated Results</div>
          <div class="results-apply-all" id="results-apply-bar">
            <button class="btn btn-primary" id="btn-apply-all" onclick="handleApplyAll()">Apply All</button>
            <div class="summary" id="results-summary"></div>
          </div>
          <div id="results-list"></div>
        </div>
      </div>
    </div>

    <!-- ===== Settings Tab ===== -->
    <div id="tab-settings" class="tab-panel">
      <div class="settings-scroll">
        <div class="first-run-banner" id="first-run-banner">
          Enter your Visionati API key to get started. Get one at <a href="https://visionati.com" target="_blank" style="color:var(--visionati-orange);font-weight:600;text-decoration:none;">visionati.com</a>
        </div>

        <div class="field-group">
          <label for="api-key">API Key</label>
          <input type="password" id="api-key" placeholder="Enter your Visionati API key" autocomplete="off">
          <div id="key-status" class="key-status"></div>
        </div>

        <div class="field-group">
          <label for="backend-select">AI Model</label>
          <select id="backend-select">
            <option value="gemini">Gemini</option>
            <option value="openai">OpenAI</option>
            <option value="claude">Claude</option>
            <option value="grok">Grok</option>
            <option value="jinaai">Jina AI</option>
            <option value="llava">LLaVA</option>
            <option value="bakllava">BakLLaVA</option>
          </select>
        </div>

        <div class="field-group">
          <label for="language-select">Language</label>
          <select id="language-select">
            <option value="Abkhazian">Abkhazian</option>
            <option value="Afar">Afar</option>
            <option value="Afrikaans">Afrikaans</option>
            <option value="Albanian">Albanian</option>
            <option value="Amharic">Amharic</option>
            <option value="Arabic">Arabic</option>
            <option value="Aragonese">Aragonese</option>
            <option value="Armenian">Armenian</option>
            <option value="Assamese">Assamese</option>
            <option value="Aymara">Aymara</option>
            <option value="Azerbaijani">Azerbaijani</option>
            <option value="Bashkir">Bashkir</option>
            <option value="Basque">Basque</option>
            <option value="Bengali (Bangla)">Bengali (Bangla)</option>
            <option value="Bhutani">Bhutani</option>
            <option value="Bihari">Bihari</option>
            <option value="Bislama">Bislama</option>
            <option value="Breton">Breton</option>
            <option value="Bulgarian">Bulgarian</option>
            <option value="Burmese">Burmese</option>
            <option value="Byelorussian (Belarusian)">Byelorussian (Belarusian)</option>
            <option value="Cambodian">Cambodian</option>
            <option value="Catalan">Catalan</option>
            <option value="Cherokee">Cherokee</option>
            <option value="Chewa">Chewa</option>
            <option value="Chinese">Chinese</option>
            <option value="Chinese (Simplified)">Chinese (Simplified)</option>
            <option value="Chinese (Traditional)">Chinese (Traditional)</option>
            <option value="Corsican">Corsican</option>
            <option value="Croatian">Croatian</option>
            <option value="Czech">Czech</option>
            <option value="Danish">Danish</option>
            <option value="Divehi">Divehi</option>
            <option value="Dutch">Dutch</option>
            <option value="Edo">Edo</option>
            <option value="English" selected>English</option>
            <option value="Esperanto">Esperanto</option>
            <option value="Estonian">Estonian</option>
            <option value="Faeroese">Faeroese</option>
            <option value="Farsi">Farsi</option>
            <option value="Fiji">Fiji</option>
            <option value="Finnish">Finnish</option>
            <option value="French">French</option>
            <option value="Frisian">Frisian</option>
            <option value="Fulfulde">Fulfulde</option>
            <option value="Galician">Galician</option>
            <option value="Gaelic (Scottish)">Gaelic (Scottish)</option>
            <option value="Gaelic (Manx)">Gaelic (Manx)</option>
            <option value="Georgian">Georgian</option>
            <option value="German">German</option>
            <option value="Greek">Greek</option>
            <option value="Greenlandic">Greenlandic</option>
            <option value="Guarani">Guarani</option>
            <option value="Gujarati">Gujarati</option>
            <option value="Haitian Creole">Haitian Creole</option>
            <option value="Hausa">Hausa</option>
            <option value="Hawaiian">Hawaiian</option>
            <option value="Hebrew">Hebrew</option>
            <option value="Hindi">Hindi</option>
            <option value="Hungarian">Hungarian</option>
            <option value="Icelandic">Icelandic</option>
            <option value="Ido">Ido</option>
            <option value="Igbo">Igbo</option>
            <option value="Indonesian">Indonesian</option>
            <option value="Interlingua">Interlingua</option>
            <option value="Interlingue">Interlingue</option>
            <option value="Inuktitut">Inuktitut</option>
            <option value="Inupiak">Inupiak</option>
            <option value="Irish">Irish</option>
            <option value="Italian">Italian</option>
            <option value="Japanese">Japanese</option>
            <option value="Javanese">Javanese</option>
            <option value="Kannada">Kannada</option>
            <option value="Kanuri">Kanuri</option>
            <option value="Kashmiri">Kashmiri</option>
            <option value="Kazakh">Kazakh</option>
            <option value="Kinyarwanda (Ruanda)">Kinyarwanda (Ruanda)</option>
            <option value="Kirghiz">Kirghiz</option>
            <option value="Kirundi (Rundi)">Kirundi (Rundi)</option>
            <option value="Konkani">Konkani</option>
            <option value="Korean">Korean</option>
            <option value="Kurdish">Kurdish</option>
            <option value="Laothian">Laothian</option>
            <option value="Latin">Latin</option>
            <option value="Latvian (Lettish)">Latvian (Lettish)</option>
            <option value="Limburgish (Limburger)">Limburgish (Limburger)</option>
            <option value="Lingala">Lingala</option>
            <option value="Lithuanian">Lithuanian</option>
            <option value="Macedonian">Macedonian</option>
            <option value="Malagasy">Malagasy</option>
            <option value="Malay">Malay</option>
            <option value="Malayalam">Malayalam</option>
            <option value="Maltese">Maltese</option>
            <option value="Maori">Maori</option>
            <option value="Marathi">Marathi</option>
            <option value="Moldavian">Moldavian</option>
            <option value="Mongolian">Mongolian</option>
            <option value="Nauru">Nauru</option>
            <option value="Nepali">Nepali</option>
            <option value="Norwegian">Norwegian</option>
            <option value="Occitan">Occitan</option>
            <option value="Oriya">Oriya</option>
            <option value="Oromo (Afaan Oromo)">Oromo (Afaan Oromo)</option>
            <option value="Papiamentu">Papiamentu</option>
            <option value="Pashto (Pushto)">Pashto (Pushto)</option>
            <option value="Polish">Polish</option>
            <option value="Portuguese">Portuguese</option>
            <option value="Punjabi">Punjabi</option>
            <option value="Quechua">Quechua</option>
            <option value="Rhaeto-Romance">Rhaeto-Romance</option>
            <option value="Romanian">Romanian</option>
            <option value="Russian">Russian</option>
            <option value="Samoan">Samoan</option>
            <option value="Sangro">Sangro</option>
            <option value="Sanskrit">Sanskrit</option>
            <option value="Serbian">Serbian</option>
            <option value="Serbo-Croatian">Serbo-Croatian</option>
            <option value="Sesotho">Sesotho</option>
            <option value="Setswana">Setswana</option>
            <option value="Shona">Shona</option>
            <option value="Sichuan Yi">Sichuan Yi</option>
            <option value="Sindhi">Sindhi</option>
            <option value="Sinhalese">Sinhalese</option>
            <option value="Siswati">Siswati</option>
            <option value="Slovak">Slovak</option>
            <option value="Slovenian">Slovenian</option>
            <option value="Somali">Somali</option>
            <option value="Spanish">Spanish</option>
            <option value="Sundanese">Sundanese</option>
            <option value="Swahili (Kiswahili)">Swahili (Kiswahili)</option>
            <option value="Swedish">Swedish</option>
            <option value="Syriac">Syriac</option>
            <option value="Tagalog">Tagalog</option>
            <option value="Tajik">Tajik</option>
            <option value="Tamazight">Tamazight</option>
            <option value="Tamil">Tamil</option>
            <option value="Tatar">Tatar</option>
            <option value="Telugu">Telugu</option>
            <option value="Thai">Thai</option>
            <option value="Tibetan">Tibetan</option>
            <option value="Tigrinya">Tigrinya</option>
            <option value="Tonga">Tonga</option>
            <option value="Tsonga">Tsonga</option>
            <option value="Turkish">Turkish</option>
            <option value="Turkmen">Turkmen</option>
            <option value="Twi">Twi</option>
            <option value="Uighur">Uighur</option>
            <option value="Ukrainian">Ukrainian</option>
            <option value="Urdu">Urdu</option>
            <option value="Uzbek">Uzbek</option>
            <option value="Venda">Venda</option>
            <option value="Vietnamese">Vietnamese</option>
            <option value="Volapük">Volapük</option>
            <option value="Wallon">Wallon</option>
            <option value="Welsh">Welsh</option>
            <option value="Wolof">Wolof</option>
            <option value="Xhosa">Xhosa</option>
            <option value="Yiddish yi">Yiddish yi</option>
            <option value="Yoruba">Yoruba</option>
            <option value="Zulu">Zulu</option>
          </select>
        </div>

        <div class="field-group">
          <label for="custom-prompt">Custom Prompt <span style="font-weight:400;text-transform:none;">(optional)</span></label>
          <textarea class="settings-textarea" id="custom-prompt" placeholder="Overrides all field roles when set..."></textarea>
          <div class="hint">Leave empty to use each field's default. When set, this prompt is used for all fields.</div>
        </div>

        <button class="btn btn-primary" id="btn-save-settings" onclick="handleSaveSettings()">Save Settings</button>
      </div>
    </div>

    <!-- Progress bar -->
    <div id="progress-container" class="progress-bar-container">
      <div class="progress-bar">
        <div id="progress-fill" class="progress-bar-fill"></div>
      </div>
    </div>

    <!-- Status bar -->
    <div id="status-bar">
      <div class="spinner"></div>
      <span id="status-text">Ready</span>
    </div>
  </div>

<script>
'use strict';

// ============================================================================
// State
// ============================================================================

var currentResults = [];
var appliedFields = {};
var isProcessing = false;
var resultsCache = {};
var currentSelectionKey = '';

var FIELD_META = {
  alt_text:    { label: 'Alt Text',    cssClass: 'alt-text' },
  caption:     { label: 'Caption',     cssClass: 'caption' },
  description: { label: 'Description', cssClass: 'description' }
};

// ============================================================================
// DOM References
// ============================================================================

var els = {
  tabs: document.querySelectorAll('.tab'),
  tabPanels: {
    generate: document.getElementById('tab-generate'),
    settings: document.getElementById('tab-settings'),
  },
  errorBanner: document.getElementById('error-banner'),
  errorMessage: document.getElementById('error-message'),
  idleMessage: document.getElementById('idle-message'),
  resultsArea: document.getElementById('results-area'),
  resultsList: document.getElementById('results-list'),
  resultsSummary: document.getElementById('results-summary'),
  btnGenerateSelection: document.getElementById('btn-generate-selection'),
  btnGeneratePage: document.getElementById('btn-generate-page'),
  btnApplyAll: document.getElementById('btn-apply-all'),
  resultsApplyBar: document.getElementById('results-apply-bar'),
  btnSaveSettings: document.getElementById('btn-save-settings'),
  statusBar: document.getElementById('status-bar'),
  statusText: document.getElementById('status-text'),
  progressContainer: document.getElementById('progress-container'),
  progressFill: document.getElementById('progress-fill'),
  apiKey: document.getElementById('api-key'),
  backendSelect: document.getElementById('backend-select'),
  languageSelect: document.getElementById('language-select'),
  customPrompt: document.getElementById('custom-prompt'),
  keyStatus: document.getElementById('key-status'),
  firstRunBanner: document.getElementById('first-run-banner'),
  selectionAnnotations: document.getElementById('selection-annotations'),
  selAnnList: document.getElementById('sel-ann-list'),
  fieldAltText: document.getElementById('field-alt-text'),
  fieldCaption: document.getElementById('field-caption'),
  fieldDescription: document.getElementById('field-description'),
  pillAltText: document.getElementById('pill-alt-text'),
  pillCaption: document.getElementById('pill-caption'),
  pillDescription: document.getElementById('pill-description'),
};

// ============================================================================
// Tab Navigation
// ============================================================================

els.tabs.forEach(function(tab) {
  tab.addEventListener('click', function() {
    switchTab(this.getAttribute('data-tab'));
  });
});

function switchTab(tabName) {
  els.tabs.forEach(function(t) {
    t.classList.toggle('active', t.getAttribute('data-tab') === tabName);
  });
  Object.keys(els.tabPanels).forEach(function(key) {
    els.tabPanels[key].classList.toggle('active', key === tabName);
  });
}

// ============================================================================
// Field Pills
// ============================================================================

function setupPill(pill, checkbox) {
  checkbox.addEventListener('change', function() {
    pill.classList.toggle('checked', checkbox.checked);
  });
}

setupPill(els.pillAltText, els.fieldAltText);
setupPill(els.pillCaption, els.fieldCaption);
setupPill(els.pillDescription, els.fieldDescription);

function getSelectedFields() {
  var fields = [];
  if (els.fieldAltText.checked) fields.push('alt_text');
  if (els.fieldCaption.checked) fields.push('caption');
  if (els.fieldDescription.checked) fields.push('description');
  return fields;
}

// ============================================================================
// Error Handling
// ============================================================================

function showError(messageOrArray) {
  var messages = Array.isArray(messageOrArray) ? messageOrArray : [messageOrArray];
  els.errorMessage.innerHTML = messages.map(function(m) {
    return '<div>' + escH(m) + '</div>';
  }).join('');
  els.errorBanner.classList.add('visible');
}

function dismissError() {
  els.errorBanner.classList.remove('visible');
}

// ============================================================================
// Status & Progress
// ============================================================================

function setStatus(message, loading) {
  els.statusText.textContent = message || 'Ready';
  els.statusBar.classList.toggle('loading', !!loading);
}

function showProgress(current, total) {
  var pct = total > 0 ? Math.round((current / total) * 100) : 0;
  els.progressFill.style.width = pct + '%';
  els.progressContainer.classList.add('visible');
}

function hideProgress() {
  els.progressContainer.classList.remove('visible');
  els.progressFill.style.width = '0%';
}

function setProcessing(processing) {
  isProcessing = processing;
  els.btnGenerateSelection.disabled = processing;
  els.btnGeneratePage.disabled = processing;
  if (!processing) hideProgress();
}

// ============================================================================
// Settings
// ============================================================================

function populateSettings(settings) {
  if (settings.apiKey) {
    els.apiKey.value = settings.apiKey;
    els.keyStatus.textContent = 'API key loaded';
    els.keyStatus.className = 'key-status valid';
    els.firstRunBanner.classList.remove('visible');
  } else {
    // No API key — first run experience
    els.firstRunBanner.classList.add('visible');
    switchTab('settings');
  }
  if (settings.backend) els.backendSelect.value = settings.backend;
  if (settings.language) els.languageSelect.value = settings.language;
  if (settings.prompt) els.customPrompt.value = settings.prompt;
}

function getSettingsFromForm() {
  return {
    apiKey: els.apiKey.value.trim(),
    backend: els.backendSelect.value,
    language: els.languageSelect.value,
    prompt: els.customPrompt.value.trim(),
  };
}

function handleSaveSettings() {
  var settings = getSettingsFromForm();
  if (!settings.apiKey) {
    showError('API key is required.');
    return;
  }
  sendToSandbox({ type: 'save-settings', settings: settings });
  els.keyStatus.textContent = 'Settings saved';
  els.keyStatus.className = 'key-status valid';
  els.firstRunBanner.classList.remove('visible');
  // Switch to generate tab after saving — user is ready to go
  switchTab('generate');
}

// ============================================================================
// Generate
// ============================================================================

function handleGenerate(source) {
  if (isProcessing) return;
  dismissError();

  var settings = getSettingsFromForm();
  if (!settings.apiKey) {
    showError('No API key. Go to Settings to add one.');
    return;
  }

  var fields = getSelectedFields();
  if (fields.length === 0) {
    showError('Select at least one field.');
    return;
  }

  // Auto-save settings
  sendToSandbox({ type: 'save-settings', settings: settings });

  setProcessing(true);
  setStatus('Starting...', true);

  var mappedSource = source === 'page' ? 'page' : 'selection';
  sendToSandbox({ type: 'generate', source: mappedSource, fields: fields });
}

// ============================================================================
// Applied State
// ============================================================================

function fieldKey(nodeId, field) { return nodeId + ':' + field; }
function isFieldApplied(nodeId, field) { return !!appliedFields[fieldKey(nodeId, field)]; }
function markFieldApplied(nodeId, field) { appliedFields[fieldKey(nodeId, field)] = true; }

function isNodeFullyApplied(nr) {
  return nr.fields.every(function(f) { return isFieldApplied(nr.nodeId, f.field); });
}

function allResultsApplied() {
  return currentResults.length > 0 && currentResults.every(function(nr) { return isNodeFullyApplied(nr); });
}

function countPendingFields() {
  var n = 0;
  currentResults.forEach(function(nr) {
    nr.fields.forEach(function(f) { if (!isFieldApplied(nr.nodeId, f.field)) n++; });
  });
  return n;
}

// ============================================================================
// Results Rendering
// ============================================================================

function mergeResults(newResults) {
  // Build a lookup of existing nodes by nodeId
  var existingMap = {};
  currentResults.forEach(function(nr) { existingMap[nr.nodeId] = nr; });

  newResults.forEach(function(nr) {
    var existing = existingMap[nr.nodeId];
    if (existing) {
      // Merge new fields into existing node — replace same field type, add new ones
      nr.fields.forEach(function(newField) {
        // Remove any previously applied marker for this field (it's being regenerated)
        var key = fieldKey(nr.nodeId, newField.field);
        delete appliedFields[key];

        // Replace existing field of same type, or add new
        var replaced = false;
        existing.fields = existing.fields.map(function(ef) {
          if (ef.field === newField.field) {
            replaced = true;
            return newField;
          }
          return ef;
        });
        if (!replaced) {
          existing.fields.push(newField);
        }
      });
    } else {
      // New node — add it and clear any stale applied state for its fields
      nr.fields.forEach(function(f) {
        delete appliedFields[fieldKey(nr.nodeId, f.field)];
      });
      currentResults.push(nr);
      existingMap[nr.nodeId] = nr;
    }
  });
}

function renderResults() {
  if (currentResults.length === 0) {
    els.idleMessage.style.display = '';
    els.resultsArea.classList.remove('visible');
    return;
  }

  // Preserve editing state before re-render so in-progress edits survive
  var editingState = {};
  var editingEntries = els.resultsList.querySelectorAll('.field-entry.editing');
  editingEntries.forEach(function(entry) {
    var id = entry.id;
    var ta = entry.querySelector('.field-edit-textarea');
    if (id && ta) {
      editingState[id] = ta.value;
    }
  });

  els.idleMessage.style.display = 'none';
  els.resultsArea.classList.add('visible');

  // Summary
  var totalFields = 0;
  var appliedCount = 0;
  currentResults.forEach(function(nr) {
    nr.fields.forEach(function(f) {
      totalFields++;
      if (isFieldApplied(nr.nodeId, f.field)) appliedCount++;
    });
  });

  var summaryParts = ['<strong>' + currentResults.length + '</strong> image' + (currentResults.length !== 1 ? 's' : '')];
  summaryParts.push('<strong>' + totalFields + '</strong> field' + (totalFields !== 1 ? 's' : ''));
  if (appliedCount > 0) summaryParts.push('<strong>' + appliedCount + '</strong> applied');
  els.resultsSummary.innerHTML = summaryParts.join(' &middot; ');

  var allDone = allResultsApplied();
  els.resultsApplyBar.style.display = allDone ? 'none' : '';

  var html = '';

  currentResults.forEach(function(nr) {
    var nodeApplied = isNodeFullyApplied(nr);
    var cardClass = 'node-card' + (nodeApplied ? ' all-applied' : '');
    var pendingFields = nr.fields.filter(function(f) { return !isFieldApplied(nr.nodeId, f.field); });

    html += '<div class="' + cardClass + '" data-node-id="' + esc(nr.nodeId) + '">';

    // Header
    html += '<div class="node-card-header">';
    if (nr.thumbnail) {
      html += '<img class="node-thumb" src="' + esc(nr.thumbnail) + '" alt="' + esc(nr.nodeName) + '">';
    }
    html += '<span class="node-name" title="' + esc(nr.nodeName) + '">' + escH(nr.nodeName) + '</span>';
    html += '<div class="node-actions">';
    if (!nodeApplied && pendingFields.length > 1) {
      html += '<button class="btn btn-primary btn-sm" onclick="handleApplyNode(\'' + esc(nr.nodeId) + '\')">Apply All</button>';
    }
    if (!nodeApplied) {
      html += '<button class="btn-text danger" onclick="handleDiscardNode(\'' + esc(nr.nodeId) + '\')">Discard</button>';
    }
    html += '</div></div>';

    // Fields
    html += '<div class="node-card-body">';
    nr.fields.forEach(function(f) {
      var fApplied = isFieldApplied(nr.nodeId, f.field);
      var meta = FIELD_META[f.field];
      var entryClass = 'field-entry' + (fApplied ? ' applied' : '');
      var entryId = 'fe-' + nr.nodeId + '-' + f.field;

      html += '<div class="' + entryClass + '" id="' + esc(entryId) + '">';

      html += '<div class="field-entry-header">';
      html += '<span class="field-badge ' + meta.cssClass + '">' + escH(meta.label) + '</span>';
      if (fApplied) {
        html += '<span class="applied-badge">Applied</span>';
      } else {
        html += '<span class="backend-label">' + escH(f.backend) + '</span>';
      }
      html += '</div>';

      var clickEdit = fApplied ? '' : ' onclick="handleEditField(\'' + esc(nr.nodeId) + '\',\'' + esc(f.field) + '\')"';
      html += '<div class="field-description-text"' + clickEdit + '>' + escH(f.description) + '</div>';
      html += '<textarea class="field-edit-textarea">' + escH(f.description) + '</textarea>';

      html += '<div class="field-actions">';
      if (!fApplied) {
        html += '<button class="btn btn-primary btn-sm" onclick="handleApplyField(\'' + esc(nr.nodeId) + '\',\'' + esc(f.field) + '\')">Apply</button>';
        if (nr.fields.length > 1) {
          html += '<span class="spacer"></span>';
          html += '<button class="btn-text danger" onclick="handleDiscardField(\'' + esc(nr.nodeId) + '\',\'' + esc(f.field) + '\')">Discard</button>';
        }
      }
      html += '</div>';

      html += '</div>';
    });
    html += '</div></div>';
  });

  els.resultsList.innerHTML = html;

  // Restore editing state for entries that still exist and aren't now applied
  Object.keys(editingState).forEach(function(id) {
    var entry = document.getElementById(id);
    if (entry && !entry.classList.contains('applied')) {
      entry.classList.add('editing');
      var ta = entry.querySelector('.field-edit-textarea');
      if (ta) ta.value = editingState[id];
    }
  });
}

// ============================================================================
// Result Actions
// ============================================================================

function getFieldEntry(nodeId, field) {
  return document.getElementById('fe-' + nodeId + '-' + field);
}

function getEditedDescription(nodeId, field) {
  var entry = getFieldEntry(nodeId, field);
  if (entry && entry.classList.contains('editing')) {
    var ta = entry.querySelector('.field-edit-textarea');
    if (ta && ta.value.trim()) return ta.value.trim();
  }
  var nr = currentResults.find(function(r) { return r.nodeId === nodeId; });
  if (!nr) return null;
  var f = nr.fields.find(function(ff) { return ff.field === field; });
  return f ? f.description : null;
}

function handleApplyField(nodeId, field) {
  var desc = getEditedDescription(nodeId, field);
  if (!desc) { showError('Description cannot be empty.'); return; }
  var nr = currentResults.find(function(r) { return r.nodeId === nodeId; });
  if (nr) {
    var f = nr.fields.find(function(ff) { return ff.field === field; });
    if (f) f.description = desc;
  }
  sendToSandbox({ type: 'apply-field', nodeId: nodeId, field: field, description: desc });
}

function handleEditField(nodeId, field) {
  var entry = getFieldEntry(nodeId, field);
  if (!entry) return;
  entry.classList.toggle('editing');
  if (entry.classList.contains('editing')) {
    var ta = entry.querySelector('.field-edit-textarea');
    if (ta) { ta.focus(); ta.setSelectionRange(ta.value.length, ta.value.length); }
  }
}

function handleDiscardField(nodeId, field) {
  var nr = currentResults.find(function(r) { return r.nodeId === nodeId; });
  if (nr) {
    nr.fields = nr.fields.filter(function(f) { return f.field !== field; });
    if (nr.fields.length === 0) {
      currentResults = currentResults.filter(function(r) { return r.nodeId !== nodeId; });
    }
  }
  sendToSandbox({ type: 'discard-field', nodeId: nodeId, field: field });
  renderResults();
}

function handleDiscardNode(nodeId) {
  currentResults = currentResults.filter(function(r) { return r.nodeId !== nodeId; });
  sendToSandbox({ type: 'discard-node', nodeId: nodeId });
  renderResults();
}

function handleApplyNode(nodeId) {
  var nr = currentResults.find(function(r) { return r.nodeId === nodeId; });
  if (!nr) return;
  var pending = [];
  nr.fields.forEach(function(f) {
    if (!isFieldApplied(nr.nodeId, f.field)) {
      var d = getEditedDescription(nr.nodeId, f.field);
      if (d) { f.description = d; pending.push({ field: f.field, description: d }); }
    }
  });
  if (pending.length === 0) return;
  sendToSandbox({ type: 'apply-node', nodeId: nodeId, fields: pending });
}

function handleApplyAll() {
  var nodes = [];
  currentResults.forEach(function(nr) {
    var pending = [];
    nr.fields.forEach(function(f) {
      if (!isFieldApplied(nr.nodeId, f.field)) {
        var d = getEditedDescription(nr.nodeId, f.field);
        if (d) { f.description = d; pending.push({ field: f.field, description: d }); }
      }
    });
    if (pending.length > 0) nodes.push({ nodeId: nr.nodeId, fields: pending });
  });
  if (nodes.length === 0) return;
  sendToSandbox({ type: 'apply-all', nodes: nodes });
}

// ============================================================================
// PostMessage
// ============================================================================

function sendToSandbox(message) {
  parent.postMessage({ pluginMessage: message }, '*');
}

window.onmessage = function(event) {
  var msg = event.data.pluginMessage;
  if (!msg) return;

  switch (msg.type) {
    case 'settings':
      populateSettings(msg.settings);
      break;

    case 'switch-tab':
      switchTab(msg.tab);
      break;

    case 'auto-generate':
      var src = msg.source === 'all-images' ? 'page' : 'selection';
      setTimeout(function() { handleGenerate(src); }, 100);
      break;

    case 'selection-changed':
      // Stash current results under the old selection key (if any)
      if (currentResults.length > 0 && currentSelectionKey) {
        resultsCache[currentSelectionKey] = {
          results: currentResults,
          applied: JSON.parse(JSON.stringify(appliedFields))
        };
      }

      // Update selection key from the new selection's node IDs
      var newIds = (msg.nodeIds || []).slice().sort();
      currentSelectionKey = newIds.join(',');

      // Try to restore cached results for this selection
      var cached = resultsCache[currentSelectionKey];
      if (cached) {
        currentResults = cached.results;
        appliedFields = cached.applied;
        delete resultsCache[currentSelectionKey];
      } else {
        currentResults = [];
        appliedFields = {};
      }
      renderResults();
      dismissError();
      if (!isProcessing) {
        var p = countPendingFields();
        if (currentResults.length > 0) {
          setStatus(p === 0 ? 'All applied!' : p + ' pending', false);
        } else {
          setStatus('Ready', false);
        }
      }
      break;

    case 'selection-annotations':
      renderSelectionAnnotations(msg.nodes || []);
      break;

    case 'status':
      setStatus(msg.message, isProcessing);
      break;

    case 'progress':
      if (msg.phase === 'exporting') {
        setStatus('Exporting ' + msg.current + '/' + msg.total + '...', true);
        showProgress(msg.current, msg.total);
      } else if (msg.phase === 'polling') {
        setStatus('Processing images (' + msg.current + '/' + msg.total + ')...', true);
        showProgress(msg.current, msg.total);
      } else if (msg.phase === 'api-call') {
        setStatus('Calling Visionati API...', true);
      }
      break;

    case 'results':
      setProcessing(false);
      mergeResults(msg.results || []);
      var nf = 0;
      currentResults.forEach(function(nr) { nf += nr.fields.length; });
      var creditsText = (msg.credits !== undefined && msg.credits !== null) ? ' · ' + msg.credits + ' credits remaining' : '';
      setStatus(nf + ' result' + (nf !== 1 ? 's' : '') + ' ready' + creditsText, false);
      renderResults();
      // Show partial field errors
      var fieldErrors = msg.fieldErrors || [];
      if (fieldErrors.length > 0) {
        var errMsgs = fieldErrors.map(function(e) { return e.message || 'Unknown error'; });
        console.warn('[Visionati] Field errors:', errMsgs);
        showError(errMsgs);
      }
      break;

    case 'error':
      setProcessing(false);
      setStatus('Error', false);
      showError(msg.messages || msg.message);
      break;

    case 'field-applied':
      markFieldApplied(msg.nodeId, msg.field);
      renderResults();
      var p = countPendingFields();
      setStatus(p === 0 ? 'All applied!' : p + ' remaining', false);
      break;

    case 'field-discarded':
    case 'node-discarded':
      break;

    case 'all-applied':
      setProcessing(false);
      var parts = [];
      if (msg.applied > 0) parts.push(msg.applied + ' image' + (msg.applied !== 1 ? 's' : '') + ' done');
      if (msg.failed > 0) parts.push(msg.failed + ' failed');
      setStatus(parts.join(', '), false);
      renderResults();
      break;
  }
};

// ============================================================================
// Selection Annotations (read-back)
// ============================================================================

var CATEGORY_LABEL_MAP = {
  'Alt Text': 'cat-alt-text',
  'Caption': 'cat-caption',
  'Description': 'cat-description'
};

function renderSelectionAnnotations(nodes) {
  if (!nodes || nodes.length === 0) {
    els.selectionAnnotations.classList.remove('visible');
    return;
  }

  // Preserve editing state before re-render so in-progress edits survive
  var editingState = {};
  var editingEntries = els.selAnnList.querySelectorAll('.sel-ann-entry.editing');
  editingEntries.forEach(function(entry) {
    var id = entry.id;
    var ta = entry.querySelector('.sel-ann-edit-textarea');
    if (id && ta) {
      editingState[id] = ta.value;
    }
  });

  els.selectionAnnotations.classList.add('visible');

  var html = '';
  nodes.forEach(function(node) {
    html += '<div class="sel-ann-node">';
    html += '<div class="sel-ann-node-header">';
    html += '<span class="sel-ann-node-name" title="' + esc(node.nodeName) + '">' + escH(node.nodeName) + '</span>';
    if (node.annotations.length > 1) {
      html += '<button class="btn-text danger" onclick="handleRemoveAllAnnotations(\'' + escAttrJS(node.nodeId) + '\')">Remove All</button>';
    }
    html += '</div>';
    node.annotations.forEach(function(ann, annIdx) {
      var entryId = 'sa-' + node.nodeId + '-' + annIdx;
      html += '<div class="sel-ann-entry" id="' + esc(entryId) + '">';
      html += '<div class="sel-ann-content">';
      var labelClass = CATEGORY_LABEL_MAP[ann.label] || '';
      var labelText = ann.label || 'Annotation';
      html += '<div class="sel-ann-label ' + labelClass + '">' + escH(labelText) + '</div>';
      var text = ann.text || '';
      text = text.replace(/^\*\*[A-Z\s]+\*\*\n?/, '');
      html += '<div class="sel-ann-text" onclick="handleEditAnnotationStart(\'' + escAttrJS(entryId) + '\')">' + escH(text) + '</div>';
      html += '<div class="sel-ann-edit-area">';
      html += '<textarea class="sel-ann-edit-textarea">' + escH(text) + '</textarea>';
      html += '<div class="sel-ann-edit-actions">';
      html += '<button class="btn btn-primary btn-sm" onclick="handleEditAnnotationSave(\'' + escAttrJS(node.nodeId) + '\',\'' + escAttrJS(labelText) + '\',\'' + escAttrJS(entryId) + '\')">Save</button>';
      html += '<button class="btn-text" onclick="handleEditAnnotationCancel(\'' + escAttrJS(entryId) + '\')">Cancel</button>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      html += '<button class="sel-ann-remove" onclick="handleRemoveAnnotation(\'' + escAttrJS(node.nodeId) + '\',\'' + escAttrJS(labelText) + '\')" title="Remove">&times;</button>';
      html += '</div>';
    });
    html += '</div>';
  });

  els.selAnnList.innerHTML = html;

  // Restore editing state for entries that still exist after re-render
  Object.keys(editingState).forEach(function(id) {
    var entry = document.getElementById(id);
    if (entry) {
      entry.classList.add('editing');
      var ta = entry.querySelector('.sel-ann-edit-textarea');
      if (ta) ta.value = editingState[id];
    }
  });
}

// ============================================================================
// Utilities
// ============================================================================

function escH(s) {
  if (!s) return '';
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function esc(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/**
 * Escape a value for embedding in a JS string inside an HTML onclick attribute.
 * Two-layer encoding: JS string escaping first, then HTML attribute escaping.
 */
function escAttrJS(s) {
  if (!s) return '';
  // JS string escaping (backslash first, then quotes and control chars)
  s = s.replace(/\\/g, '\\\\');
  s = s.replace(/'/g, "\\'");
  s = s.replace(/\n/g, '\\n');
  s = s.replace(/\r/g, '\\r');
  // HTML attribute escaping (so the value doesn't break the onclick="..." wrapper)
  s = s.replace(/&/g, '&amp;');
  s = s.replace(/</g, '&lt;');
  s = s.replace(/>/g, '&gt;');
  s = s.replace(/"/g, '&quot;');
  return s;
}

// ============================================================================
// Init
// ============================================================================

function handleRemoveAnnotation(nodeId, categoryLabel) {
  sendToSandbox({ type: 'remove-annotation', nodeId: nodeId, categoryLabel: categoryLabel });
}

function handleRemoveAllAnnotations(nodeId) {
  sendToSandbox({ type: 'remove-all-annotations', nodeId: nodeId });
}

function handleEditAnnotationStart(entryId) {
  var entry = document.getElementById(entryId);
  if (!entry || entry.classList.contains('editing')) return;
  entry.classList.add('editing');
  var ta = entry.querySelector('.sel-ann-edit-textarea');
  if (ta) { ta.focus(); ta.setSelectionRange(ta.value.length, ta.value.length); }
}

function handleEditAnnotationCancel(entryId) {
  var entry = document.getElementById(entryId);
  if (entry) entry.classList.remove('editing');
}

function handleEditAnnotationSave(nodeId, categoryLabel, entryId) {
  var entry = document.getElementById(entryId);
  if (!entry) return;
  var ta = entry.querySelector('.sel-ann-edit-textarea');
  if (!ta || !ta.value.trim()) { showError('Annotation text cannot be empty.'); return; }
  // Exit editing mode on this entry so the re-render from sendSelectionAnnotations
  // only preserves OTHER entries that are still being edited (not this one)
  entry.classList.remove('editing');
  sendToSandbox({ type: 'edit-annotation', nodeId: nodeId, categoryLabel: categoryLabel, newText: ta.value.trim() });
}

// Settings are sent proactively by the sandbox in showPluginUI(),
// so no need to request them again from the UI side.

</script>
</body>
</html>