<!DOCTYPE html>
<html>
<head>
<style>
  :root {
    --spacing: 8px;
    --spacing-sm: 4px;
    --spacing-lg: 12px;
    --spacing-xl: 16px;
    --radius: 6px;
    --radius-sm: 4px;
    --font-size-xs: 11px;
    --font-size-sm: 12px;
    --font-size-base: 13px;
    --font-size-lg: 14px;
    --transition: 150ms ease;
    --visionati-orange: #fb7300;
    --visionati-orange-hover: #e06800;
    --color-alt-text: #2ecc71;
    --color-caption: #3498db;
    --color-description: #9b59b6;
    --color-applied: #27ae60;
    --color-error: #e74c3c;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    font-family: 'Inter', 'Figma Sans', system-ui, -apple-system, BlinkMacSystemFont,
      'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    font-size: var(--font-size-base);
    background-color: var(--figma-color-bg);
    color: var(--figma-color-text);
    overflow-x: hidden;
  }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--figma-color-border); border-radius: 3px; }

  /* ===== Layout ===== */

  #plugin-container {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  #tabs {
    display: flex;
    border-bottom: 1px solid var(--figma-color-border);
    flex-shrink: 0;
  }

  .tab {
    flex: 1;
    padding: 10px var(--spacing);
    text-align: center;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--figma-color-text-secondary);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: color var(--transition), border-color var(--transition);
    letter-spacing: 0.01em;
  }

  .tab:hover { color: var(--figma-color-text); }

  .tab.active {
    color: var(--figma-color-text);
    border-bottom-color: var(--visionati-orange);
  }

  .tab-panel {
    display: none;
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-xl);
  }

  .tab-panel.active {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  /* ===== Form Elements ===== */

  .field-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .field-group label {
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--figma-color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .field-group .hint {
    font-size: var(--font-size-xs);
    color: var(--figma-color-text-tertiary, var(--figma-color-text-secondary));
    font-weight: 400;
    text-transform: none;
    letter-spacing: normal;
    margin-top: -2px;
  }

  input[type="password"],
  input[type="text"],
  select,
  textarea {
    width: 100%;
    padding: 7px var(--spacing);
    font-family: inherit;
    font-size: var(--font-size-base);
    color: var(--figma-color-text);
    background-color: var(--figma-color-bg-secondary);
    border: 1px solid var(--figma-color-border);
    border-radius: var(--radius-sm);
    outline: none;
    transition: border-color var(--transition);
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--figma-color-border-selected);
  }

  textarea {
    resize: vertical;
    min-height: 60px;
    font-size: var(--font-size-sm);
    line-height: 1.5;
  }

  select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='8' height='5' viewBox='0 0 8 5' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0.5 0.5L4 4L7.5 0.5' stroke='%23999' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    padding-right: 24px;
  }

  /* ===== Buttons ===== */

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px var(--spacing-lg);
    font-family: inherit;
    font-size: var(--font-size-sm);
    font-weight: 600;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background-color var(--transition), opacity var(--transition);
    white-space: nowrap;
  }

  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-primary {
    background-color: var(--visionati-orange);
    color: #fff;
  }
  .btn-primary:hover:not(:disabled) { background-color: var(--visionati-orange-hover); }

  .btn-brand {
    background-color: var(--figma-color-bg-brand);
    color: var(--figma-color-text-onbrand);
  }
  .btn-brand:hover:not(:disabled) { opacity: 0.9; }

  .btn-secondary {
    background-color: var(--figma-color-bg-secondary);
    color: var(--figma-color-text);
    border: 1px solid var(--figma-color-border);
  }
  .btn-secondary:hover:not(:disabled) { background-color: var(--figma-color-border); }

  .btn-sm { padding: 5px var(--spacing); font-size: var(--font-size-xs); }

  .btn-danger-text {
    background: none;
    border: none;
    color: var(--figma-color-text-secondary);
    font-size: var(--font-size-xs);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: var(--radius-sm);
  }
  .btn-danger-text:hover { color: var(--color-error); background: rgba(231, 76, 60, 0.08); }

  .actions-row {
    display: flex;
    gap: var(--spacing);
  }
  .actions-row .btn { flex: 1; }

  /* ===== Checkbox ===== */

  .checkbox-row {
    display: flex;
    align-items: center;
    gap: var(--spacing);
  }

  .checkbox-row input[type="checkbox"] {
    width: 14px;
    height: 14px;
    accent-color: var(--visionati-orange);
    cursor: pointer;
    flex-shrink: 0;
  }

  .checkbox-row label {
    font-size: var(--font-size-sm);
    color: var(--figma-color-text);
    cursor: pointer;
    text-transform: none;
    letter-spacing: normal;
    font-weight: 400;
  }

  /* ===== Field Checkboxes ===== */

  .field-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .field-checkboxes-label {
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--figma-color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 2px;
  }

  .field-checkbox-row {
    display: flex;
    align-items: center;
    gap: var(--spacing);
    padding: 5px var(--spacing);
    border-radius: var(--radius-sm);
    transition: background-color var(--transition);
  }

  .field-checkbox-row:hover {
    background-color: var(--figma-color-bg-secondary);
  }

  .field-checkbox-row input[type="checkbox"] {
    width: 14px;
    height: 14px;
    cursor: pointer;
    flex-shrink: 0;
  }

  .field-checkbox-row input[type="checkbox"].field-alt-text { accent-color: var(--color-alt-text); }
  .field-checkbox-row input[type="checkbox"].field-caption { accent-color: var(--color-caption); }
  .field-checkbox-row input[type="checkbox"].field-description { accent-color: var(--color-description); }

  .field-checkbox-row label {
    font-size: var(--font-size-sm);
    cursor: pointer;
    flex: 1;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .field-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .field-dot.alt-text { background-color: var(--color-alt-text); }
  .field-dot.caption { background-color: var(--color-caption); }
  .field-dot.description { background-color: var(--color-description); }

  .field-role-hint {
    font-size: var(--font-size-xs);
    color: var(--figma-color-text-secondary);
    margin-left: auto;
    flex-shrink: 0;
  }

  /* ===== Status Bar ===== */

  #status-bar {
    flex-shrink: 0;
    padding: 6px var(--spacing-xl);
    font-size: var(--font-size-xs);
    color: var(--figma-color-text-secondary);
    border-top: 1px solid var(--figma-color-border);
    min-height: 28px;
    display: flex;
    align-items: center;
    gap: var(--spacing);
    background-color: var(--figma-color-bg);
  }

  #status-bar .spinner {
    display: none;
    width: 12px;
    height: 12px;
    border: 2px solid var(--figma-color-border);
    border-top-color: var(--visionati-orange);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    flex-shrink: 0;
  }

  #status-bar.loading .spinner { display: block; }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== Progress Bar ===== */

  .progress-bar-container {
    display: none;
    flex-shrink: 0;
    padding: 0 var(--spacing-xl) var(--spacing);
  }
  .progress-bar-container.visible { display: block; }

  .progress-bar {
    width: 100%;
    height: 3px;
    background-color: var(--figma-color-border);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background-color: var(--visionati-orange);
    border-radius: 2px;
    transition: width 300ms ease;
    width: 0%;
  }

  /* ===== Error Banner ===== */

  .error-banner {
    display: none;
    padding: var(--spacing) var(--spacing-lg);
    background-color: rgba(231, 76, 60, 0.1);
    border: 1px solid rgba(231, 76, 60, 0.3);
    border-radius: var(--radius-sm);
    color: var(--color-error);
    font-size: var(--font-size-sm);
    line-height: 1.4;
    word-break: break-word;
  }
  .error-banner.visible { display: block; }

  .error-banner .dismiss {
    float: right;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    font-size: 16px;
    line-height: 1;
    padding: 0 0 0 8px;
    opacity: 0.7;
  }
  .error-banner .dismiss:hover { opacity: 1; }

  /* ===== Result Cards ===== */

  #results-area {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing);
  }

  .results-header h3 {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin: 0;
  }

  .results-summary {
    font-size: var(--font-size-xs);
    color: var(--figma-color-text-secondary);
  }

  /* Node card — groups fields for one image */
  .node-card {
    border: 1px solid var(--figma-color-border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: border-color var(--transition);
  }

  .node-card.all-applied { border-color: var(--color-applied); }

  .node-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing) var(--spacing-lg);
    background-color: var(--figma-color-bg-secondary);
    border-bottom: 1px solid var(--figma-color-border);
    gap: var(--spacing);
  }

  .node-card-header .node-name {
    font-size: var(--font-size-sm);
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    min-width: 0;
  }

  .node-card-header .node-actions {
    display: flex;
    gap: 4px;
    align-items: center;
    flex-shrink: 0;
  }

  .node-card-body {
    display: flex;
    flex-direction: column;
  }

  /* Field entry — one field within a node card */
  .field-entry {
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--figma-color-border);
    transition: opacity var(--transition);
  }

  .field-entry:last-child { border-bottom: none; }

  .field-entry.applied { opacity: 0.55; }

  .field-entry-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: var(--spacing);
  }

  .field-badge {
    font-size: var(--font-size-xs);
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 3px;
    white-space: nowrap;
  }

  .field-badge.alt-text { background-color: rgba(46, 204, 113, 0.15); color: #27ae60; }
  .field-badge.caption { background-color: rgba(52, 152, 219, 0.15); color: #2980b9; }
  .field-badge.description { background-color: rgba(155, 89, 182, 0.15); color: #8e44ad; }

  .field-entry-header .backend-label {
    font-size: var(--font-size-xs);
    color: var(--figma-color-text-secondary);
    margin-left: auto;
  }

  .field-entry-header .applied-badge {
    font-size: var(--font-size-xs);
    padding: 2px 6px;
    border-radius: 3px;
    background-color: rgba(46, 204, 113, 0.15);
    color: var(--color-applied);
    font-weight: 600;
    margin-left: auto;
  }

  .field-description-text {
    font-size: var(--font-size-sm);
    line-height: 1.6;
    color: var(--figma-color-text);
    white-space: pre-wrap;
    word-break: break-word;
    margin-bottom: var(--spacing);
  }

  .field-edit-textarea {
    display: none;
    width: 100%;
    min-height: 70px;
    margin-bottom: var(--spacing);
  }

  .field-entry.editing .field-description-text { display: none; }
  .field-entry.editing .field-edit-textarea { display: block; }

  .field-actions {
    display: flex;
    gap: var(--spacing);
    align-items: center;
  }

  .field-actions .spacer { flex: 1; }

  .field-entry.applied .field-actions .btn,
  .field-entry.applied .field-actions .btn-danger-text { display: none; }

  /* ===== Empty State ===== */

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px var(--spacing-xl);
    gap: var(--spacing-lg);
    flex: 1;
  }

  .empty-state .icon { font-size: 32px; opacity: 0.4; }

  .empty-state p {
    font-size: var(--font-size-sm);
    color: var(--figma-color-text-secondary);
    line-height: 1.5;
    max-width: 280px;
  }



  /* ===== Key verified indicator ===== */

  .key-status {
    font-size: var(--font-size-xs);
    padding: 2px 0;
  }
  .key-status.valid { color: #27ae60; }
  .key-status.invalid { color: var(--color-error); }

  /* ===== Divider ===== */
  .divider {
    height: 1px;
    background-color: var(--figma-color-border);
    margin: var(--spacing-sm) 0;
  }
</style>
</head>
<body>
  <div id="plugin-container">
    <!-- Tabs -->
    <div id="tabs">
      <button class="tab active" data-tab="generate">Generate</button>
      <button class="tab" data-tab="results">Results</button>
      <button class="tab" data-tab="settings">Settings</button>
    </div>

    <!-- ===== Generate Tab ===== -->
    <div id="tab-generate" class="tab-panel active">
      <div id="error-banner" class="error-banner">
        <button class="dismiss" onclick="dismissError()">&times;</button>
        <span id="error-message"></span>
      </div>

      <div class="empty-state" id="generate-empty">
        <div class="icon">&#x1F5BC;&#xFE0F;</div>
        <p>Select layers with images, then choose which fields to generate. Or scan the entire page for images missing annotations.</p>
      </div>

      <!-- Field checkboxes -->
      <div class="field-checkboxes">
        <div class="field-checkboxes-label">Fields to Generate</div>
        <div class="field-checkbox-row">
          <input type="checkbox" id="field-alt-text" class="field-alt-text" checked>
          <label for="field-alt-text">
            <span class="field-dot alt-text"></span>
            Alt Text
          </label>
          <span class="field-role-hint">WCAG-compliant</span>
        </div>
        <div class="field-checkbox-row">
          <input type="checkbox" id="field-caption" class="field-caption">
          <label for="field-caption">
            <span class="field-dot caption"></span>
            Caption
          </label>
          <span class="field-role-hint">Short display text</span>
        </div>
        <div class="field-checkbox-row">
          <input type="checkbox" id="field-description" class="field-description">
          <label for="field-description">
            <span class="field-dot description"></span>
            Description
          </label>
          <span class="field-role-hint">Longer prose</span>
        </div>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="overwrite-existing">
        <label for="overwrite-existing">Include images with existing annotations</label>
      </div>

      <div class="actions-row">
        <button class="btn btn-primary" id="btn-generate-selection" onclick="handleGenerate('selection')">
          &#x2726; Selection
        </button>
        <button class="btn btn-brand" id="btn-generate-page" onclick="handleGenerate('page')">
          &#x2B21; Scan Page
        </button>
      </div>


    </div>

    <!-- ===== Results Tab ===== -->
    <div id="tab-results" class="tab-panel">
      <div id="results-empty" class="empty-state">
        <div class="icon">&#x1F4DD;</div>
        <p>No results yet. Generate from the Generate tab to see previews here.</p>
      </div>

      <div id="results-area" style="display:none;">
        <div class="results-header">
          <div>
            <h3>Preview</h3>
            <div class="results-summary" id="results-summary"></div>
          </div>
          <button class="btn btn-primary btn-sm" id="btn-apply-all" onclick="handleApplyAll()">Apply All</button>
        </div>
        <div id="results-list"></div>
      </div>
    </div>

    <!-- ===== Settings Tab ===== -->
    <div id="tab-settings" class="tab-panel">
      <div class="field-group">
        <label for="api-key">API Key</label>
        <input type="password" id="api-key" placeholder="Enter your Visionati API key" autocomplete="off">
        <div id="key-status" class="key-status"></div>
      </div>

      <div class="field-group">
        <label for="backend-select">AI Model</label>
        <select id="backend-select">
          <option value="gemini">Gemini</option>
          <option value="openai">OpenAI</option>
          <option value="claude">Claude</option>
          <option value="grok">Grok</option>
          <option value="jinaai">Jina AI</option>
          <option value="llava">LLaVA</option>
          <option value="bakllava">BakLLaVA</option>
        </select>
      </div>

      <div class="field-group">
        <label for="language-select">Language</label>
        <select id="language-select">
          <option value="Abkhazian">Abkhazian</option>
          <option value="Afar">Afar</option>
          <option value="Afrikaans">Afrikaans</option>
          <option value="Albanian">Albanian</option>
          <option value="Amharic">Amharic</option>
          <option value="Arabic">Arabic</option>
          <option value="Aragonese">Aragonese</option>
          <option value="Armenian">Armenian</option>
          <option value="Assamese">Assamese</option>
          <option value="Aymara">Aymara</option>
          <option value="Azerbaijani">Azerbaijani</option>
          <option value="Bashkir">Bashkir</option>
          <option value="Basque">Basque</option>
          <option value="Bengali (Bangla)">Bengali (Bangla)</option>
          <option value="Bhutani">Bhutani</option>
          <option value="Bihari">Bihari</option>
          <option value="Bislama">Bislama</option>
          <option value="Breton">Breton</option>
          <option value="Bulgarian">Bulgarian</option>
          <option value="Burmese">Burmese</option>
          <option value="Byelorussian (Belarusian)">Byelorussian (Belarusian)</option>
          <option value="Cambodian">Cambodian</option>
          <option value="Catalan">Catalan</option>
          <option value="Cherokee">Cherokee</option>
          <option value="Chewa">Chewa</option>
          <option value="Chinese">Chinese</option>
          <option value="Chinese (Simplified)">Chinese (Simplified)</option>
          <option value="Chinese (Traditional)">Chinese (Traditional)</option>
          <option value="Corsican">Corsican</option>
          <option value="Croatian">Croatian</option>
          <option value="Czech">Czech</option>
          <option value="Danish">Danish</option>
          <option value="Divehi">Divehi</option>
          <option value="Dutch">Dutch</option>
          <option value="Edo">Edo</option>
          <option value="English" selected>English</option>
          <option value="Esperanto">Esperanto</option>
          <option value="Estonian">Estonian</option>
          <option value="Faeroese">Faeroese</option>
          <option value="Farsi">Farsi</option>
          <option value="Fiji">Fiji</option>
          <option value="Finnish">Finnish</option>
          <option value="French">French</option>
          <option value="Frisian">Frisian</option>
          <option value="Fulfulde">Fulfulde</option>
          <option value="Galician">Galician</option>
          <option value="Gaelic (Scottish)">Gaelic (Scottish)</option>
          <option value="Gaelic (Manx)">Gaelic (Manx)</option>
          <option value="Georgian">Georgian</option>
          <option value="German">German</option>
          <option value="Greek">Greek</option>
          <option value="Greenlandic">Greenlandic</option>
          <option value="Guarani">Guarani</option>
          <option value="Gujarati">Gujarati</option>
          <option value="Haitian Creole">Haitian Creole</option>
          <option value="Hausa">Hausa</option>
          <option value="Hawaiian">Hawaiian</option>
          <option value="Hebrew">Hebrew</option>
          <option value="Hindi">Hindi</option>
          <option value="Hungarian">Hungarian</option>
          <option value="Icelandic">Icelandic</option>
          <option value="Ido">Ido</option>
          <option value="Igbo">Igbo</option>
          <option value="Indonesian">Indonesian</option>
          <option value="Interlingua">Interlingua</option>
          <option value="Interlingue">Interlingue</option>
          <option value="Inuktitut">Inuktitut</option>
          <option value="Inupiak">Inupiak</option>
          <option value="Irish">Irish</option>
          <option value="Italian">Italian</option>
          <option value="Japanese">Japanese</option>
          <option value="Javanese">Javanese</option>
          <option value="Kannada">Kannada</option>
          <option value="Kanuri">Kanuri</option>
          <option value="Kashmiri">Kashmiri</option>
          <option value="Kazakh">Kazakh</option>
          <option value="Kinyarwanda (Ruanda)">Kinyarwanda (Ruanda)</option>
          <option value="Kirghiz">Kirghiz</option>
          <option value="Kirundi (Rundi)">Kirundi (Rundi)</option>
          <option value="Konkani">Konkani</option>
          <option value="Korean">Korean</option>
          <option value="Kurdish">Kurdish</option>
          <option value="Laothian">Laothian</option>
          <option value="Latin">Latin</option>
          <option value="Latvian (Lettish)">Latvian (Lettish)</option>
          <option value="Limburgish (Limburger)">Limburgish (Limburger)</option>
          <option value="Lingala">Lingala</option>
          <option value="Lithuanian">Lithuanian</option>
          <option value="Macedonian">Macedonian</option>
          <option value="Malagasy">Malagasy</option>
          <option value="Malay">Malay</option>
          <option value="Malayalam">Malayalam</option>
          <option value="Maltese">Maltese</option>
          <option value="Maori">Maori</option>
          <option value="Marathi">Marathi</option>
          <option value="Moldavian">Moldavian</option>
          <option value="Mongolian">Mongolian</option>
          <option value="Nauru">Nauru</option>
          <option value="Nepali">Nepali</option>
          <option value="Norwegian">Norwegian</option>
          <option value="Occitan">Occitan</option>
          <option value="Oriya">Oriya</option>
          <option value="Oromo (Afaan Oromo)">Oromo (Afaan Oromo)</option>
          <option value="Papiamentu">Papiamentu</option>
          <option value="Pashto (Pushto)">Pashto (Pushto)</option>
          <option value="Polish">Polish</option>
          <option value="Portuguese">Portuguese</option>
          <option value="Punjabi">Punjabi</option>
          <option value="Quechua">Quechua</option>
          <option value="Rhaeto-Romance">Rhaeto-Romance</option>
          <option value="Romanian">Romanian</option>
          <option value="Russian">Russian</option>
          <option value="Samoan">Samoan</option>
          <option value="Sangro">Sangro</option>
          <option value="Sanskrit">Sanskrit</option>
          <option value="Serbian">Serbian</option>
          <option value="Serbo-Croatian">Serbo-Croatian</option>
          <option value="Sesotho">Sesotho</option>
          <option value="Setswana">Setswana</option>
          <option value="Shona">Shona</option>
          <option value="Sichuan Yi">Sichuan Yi</option>
          <option value="Sindhi">Sindhi</option>
          <option value="Sinhalese">Sinhalese</option>
          <option value="Siswati">Siswati</option>
          <option value="Slovak">Slovak</option>
          <option value="Slovenian">Slovenian</option>
          <option value="Somali">Somali</option>
          <option value="Spanish">Spanish</option>
          <option value="Sundanese">Sundanese</option>
          <option value="Swahili (Kiswahili)">Swahili (Kiswahili)</option>
          <option value="Swedish">Swedish</option>
          <option value="Syriac">Syriac</option>
          <option value="Tagalog">Tagalog</option>
          <option value="Tajik">Tajik</option>
          <option value="Tamazight">Tamazight</option>
          <option value="Tamil">Tamil</option>
          <option value="Tatar">Tatar</option>
          <option value="Telugu">Telugu</option>
          <option value="Thai">Thai</option>
          <option value="Tibetan">Tibetan</option>
          <option value="Tigrinya">Tigrinya</option>
          <option value="Tonga">Tonga</option>
          <option value="Tsonga">Tsonga</option>
          <option value="Turkish">Turkish</option>
          <option value="Turkmen">Turkmen</option>
          <option value="Twi">Twi</option>
          <option value="Uighur">Uighur</option>
          <option value="Ukrainian">Ukrainian</option>
          <option value="Urdu">Urdu</option>
          <option value="Uzbek">Uzbek</option>
          <option value="Venda">Venda</option>
          <option value="Vietnamese">Vietnamese</option>
          <option value="Volapük">Volapük</option>
          <option value="Wallon">Wallon</option>
          <option value="Welsh">Welsh</option>
          <option value="Wolof">Wolof</option>
          <option value="Xhosa">Xhosa</option>
          <option value="Yiddish yi">Yiddish yi</option>
          <option value="Yoruba">Yoruba</option>
          <option value="Zulu">Zulu</option>
        </select>
      </div>

      <div class="field-group">
        <label for="custom-prompt">Custom Prompt <span style="font-weight:400;text-transform:none;">(optional, overrides all field roles)</span></label>
        <textarea id="custom-prompt" placeholder="e.g. Describe this image for a visually impaired user, focusing on the key visual elements..."></textarea>
        <div class="hint">Leave empty to use each field's default role. When set, this prompt is used for all fields.</div>
      </div>

      <button class="btn btn-primary" id="btn-save-settings" onclick="handleSaveSettings()">Save Settings</button>
    </div>

    <!-- Progress Bar -->
    <div id="progress-container" class="progress-bar-container">
      <div class="progress-bar">
        <div id="progress-fill" class="progress-bar-fill"></div>
      </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar">
      <div class="spinner"></div>
      <span id="status-text">Ready</span>
    </div>
  </div>

<script>
'use strict';

// ============================================================================
// State
// ============================================================================

var currentResults = []; // Array of { nodeId, nodeName, hasExistingAnnotation, fields: [{ field, description, backend }] }
var appliedFields = {}; // { "nodeId:field": true }
var isProcessing = false;

// Field type labels and CSS classes
var FIELD_META = {
  alt_text:    { label: 'Alt Text',    cssClass: 'alt-text' },
  caption:     { label: 'Caption',     cssClass: 'caption' },
  description: { label: 'Description', cssClass: 'description' }
};

// ============================================================================
// DOM References
// ============================================================================

var els = {
  tabs: document.querySelectorAll('.tab'),
  tabPanels: {
    generate: document.getElementById('tab-generate'),
    results: document.getElementById('tab-results'),
    settings: document.getElementById('tab-settings'),
  },
  errorBanner: document.getElementById('error-banner'),
  errorMessage: document.getElementById('error-message'),
  generateEmpty: document.getElementById('generate-empty'),
  resultsEmpty: document.getElementById('results-empty'),
  resultsArea: document.getElementById('results-area'),
  resultsList: document.getElementById('results-list'),
  resultsSummary: document.getElementById('results-summary'),
  btnGenerateSelection: document.getElementById('btn-generate-selection'),
  btnGeneratePage: document.getElementById('btn-generate-page'),
  btnApplyAll: document.getElementById('btn-apply-all'),
  btnSaveSettings: document.getElementById('btn-save-settings'),
  overwriteExisting: document.getElementById('overwrite-existing'),
  statusBar: document.getElementById('status-bar'),
  statusText: document.getElementById('status-text'),
  progressContainer: document.getElementById('progress-container'),
  progressFill: document.getElementById('progress-fill'),
  apiKey: document.getElementById('api-key'),
  backendSelect: document.getElementById('backend-select'),
  languageSelect: document.getElementById('language-select'),
  customPrompt: document.getElementById('custom-prompt'),
  keyStatus: document.getElementById('key-status'),
  fieldAltText: document.getElementById('field-alt-text'),
  fieldCaption: document.getElementById('field-caption'),
  fieldDescription: document.getElementById('field-description'),
};

// ============================================================================
// Tab Navigation
// ============================================================================

els.tabs.forEach(function(tab) {
  tab.addEventListener('click', function() {
    switchTab(this.getAttribute('data-tab'));
  });
});

function switchTab(tabName) {
  els.tabs.forEach(function(t) {
    t.classList.toggle('active', t.getAttribute('data-tab') === tabName);
  });
  Object.keys(els.tabPanels).forEach(function(key) {
    els.tabPanels[key].classList.toggle('active', key === tabName);
  });
}

// ============================================================================
// Error Handling
// ============================================================================

function showError(message) {
  els.errorMessage.textContent = message;
  els.errorBanner.classList.add('visible');
}

function dismissError() {
  els.errorBanner.classList.remove('visible');
}

// ============================================================================
// Status & Progress
// ============================================================================

function setStatus(message, loading) {
  els.statusText.textContent = message || 'Ready';
  els.statusBar.classList.toggle('loading', !!loading);
}

function showProgress(current, total) {
  var pct = total > 0 ? Math.round((current / total) * 100) : 0;
  els.progressFill.style.width = pct + '%';
  els.progressContainer.classList.add('visible');
}

function hideProgress() {
  els.progressContainer.classList.remove('visible');
  els.progressFill.style.width = '0%';
}

function setProcessing(processing) {
  isProcessing = processing;
  els.btnGenerateSelection.disabled = processing;
  els.btnGeneratePage.disabled = processing;
  if (!processing) hideProgress();
}

// ============================================================================
// Fields
// ============================================================================

function getSelectedFields() {
  var fields = [];
  if (els.fieldAltText.checked) fields.push('alt_text');
  if (els.fieldCaption.checked) fields.push('caption');
  if (els.fieldDescription.checked) fields.push('description');
  return fields;
}



// ============================================================================
// Settings
// ============================================================================

function populateSettings(settings) {
  if (settings.apiKey) {
    els.apiKey.value = settings.apiKey;
    els.keyStatus.textContent = 'API key loaded from storage';
    els.keyStatus.className = 'key-status valid';
  }
  if (settings.backend) els.backendSelect.value = settings.backend;
  if (settings.language) els.languageSelect.value = settings.language;
  if (settings.prompt) els.customPrompt.value = settings.prompt;
}

function getSettingsFromForm() {
  return {
    apiKey: els.apiKey.value.trim(),
    backend: els.backendSelect.value,
    language: els.languageSelect.value,
    prompt: els.customPrompt.value.trim(),
  };
}

function handleSaveSettings() {
  var settings = getSettingsFromForm();
  if (!settings.apiKey) {
    showError('API key is required.');
    switchTab('settings');
    return;
  }
  sendToSandbox({ type: 'save-settings', settings: settings });
  els.keyStatus.textContent = 'Settings saved';
  els.keyStatus.className = 'key-status valid';
}

// ============================================================================
// Generate
// ============================================================================

function handleGenerate(source) {
  if (isProcessing) return;
  dismissError();

  var settings = getSettingsFromForm();
  if (!settings.apiKey) {
    showError('API key is required. Go to Settings and enter your Visionati API key.');
    return;
  }

  var fields = getSelectedFields();
  if (fields.length === 0) {
    showError('Select at least one field to generate (Alt Text, Caption, or Description).');
    return;
  }

  sendToSandbox({ type: 'save-settings', settings: settings });

  setProcessing(true);
  setStatus('Starting...', true);

  currentResults = [];
  appliedFields = {};
  renderResults();

  var overwrite = els.overwriteExisting.checked;
  var mappedSource = source === 'page' ? 'page' : 'selection';
  sendToSandbox({ type: 'generate', source: mappedSource, fields: fields, overwrite: overwrite });
}

// ============================================================================
// Applied State Helpers
// ============================================================================

function fieldKey(nodeId, field) {
  return nodeId + ':' + field;
}

function isFieldApplied(nodeId, field) {
  return !!appliedFields[fieldKey(nodeId, field)];
}

function markFieldApplied(nodeId, field) {
  appliedFields[fieldKey(nodeId, field)] = true;
}

function isNodeFullyApplied(nodeResult) {
  return nodeResult.fields.every(function(f) {
    return isFieldApplied(nodeResult.nodeId, f.field);
  });
}

function allResultsApplied() {
  return currentResults.every(function(nr) { return isNodeFullyApplied(nr); });
}

function countPendingFields() {
  var count = 0;
  currentResults.forEach(function(nr) {
    nr.fields.forEach(function(f) {
      if (!isFieldApplied(nr.nodeId, f.field)) count++;
    });
  });
  return count;
}

// ============================================================================
// Results Rendering
// ============================================================================

function renderResults() {
  if (currentResults.length === 0) {
    els.resultsEmpty.style.display = '';
    els.resultsArea.style.display = 'none';
    return;
  }

  els.resultsEmpty.style.display = 'none';
  els.resultsArea.style.display = '';

  // Summary
  var totalFields = 0;
  var appliedCount = 0;
  currentResults.forEach(function(nr) {
    nr.fields.forEach(function(f) {
      totalFields++;
      if (isFieldApplied(nr.nodeId, f.field)) appliedCount++;
    });
  });
  els.resultsSummary.textContent = currentResults.length + ' image' + (currentResults.length !== 1 ? 's' : '') +
    ', ' + totalFields + ' field' + (totalFields !== 1 ? 's' : '') +
    (appliedCount > 0 ? ' (' + appliedCount + ' applied)' : '');

  // Apply All button visibility
  els.btnApplyAll.style.display = allResultsApplied() ? 'none' : '';

  var html = '';

  currentResults.forEach(function(nr) {
    var nodeApplied = isNodeFullyApplied(nr);
    var cardClass = 'node-card' + (nodeApplied ? ' all-applied' : '');
    var pendingFieldsForNode = nr.fields.filter(function(f) { return !isFieldApplied(nr.nodeId, f.field); });

    html += '<div class="' + cardClass + '" data-node-id="' + escapeAttr(nr.nodeId) + '">';

    // Node header
    html += '<div class="node-card-header">';
    html += '<span class="node-name" title="' + escapeAttr(nr.nodeName) + '">' + escapeHtml(nr.nodeName) + '</span>';
    html += '<div class="node-actions">';
    if (!nodeApplied && pendingFieldsForNode.length > 1) {
      html += '<button class="btn btn-primary btn-sm" onclick="handleApplyNode(\'' + escapeAttr(nr.nodeId) + '\')">Apply All Fields</button>';
    }
    if (!nodeApplied) {
      html += '<button class="btn-danger-text" onclick="handleDiscardNode(\'' + escapeAttr(nr.nodeId) + '\')">Discard</button>';
    }
    html += '</div>';
    html += '</div>';

    // Fields
    html += '<div class="node-card-body">';
    nr.fields.forEach(function(f) {
      var fApplied = isFieldApplied(nr.nodeId, f.field);
      var meta = FIELD_META[f.field];
      var entryClass = 'field-entry' + (fApplied ? ' applied' : '');
      var entryId = 'field-' + nr.nodeId + '-' + f.field;

      html += '<div class="' + entryClass + '" id="' + escapeAttr(entryId) + '" data-node-id="' + escapeAttr(nr.nodeId) + '" data-field="' + escapeAttr(f.field) + '">';

      // Field header
      html += '<div class="field-entry-header">';
      html += '<span class="field-badge ' + meta.cssClass + '">' + escapeHtml(meta.label) + '</span>';
      if (fApplied) {
        html += '<span class="applied-badge">Applied</span>';
      } else {
        html += '<span class="backend-label">' + escapeHtml(f.backend) + '</span>';
      }
      html += '</div>';

      // Description text + edit textarea
      html += '<div class="field-description-text">' + escapeHtml(f.description) + '</div>';
      html += '<textarea class="field-edit-textarea">' + escapeHtml(f.description) + '</textarea>';

      // Actions
      html += '<div class="field-actions">';
      if (!fApplied) {
        html += '<button class="btn btn-primary btn-sm" onclick="handleApplyField(\'' + escapeAttr(nr.nodeId) + '\',\'' + escapeAttr(f.field) + '\')">Apply</button>';
        html += '<button class="btn btn-secondary btn-sm" onclick="handleEditField(\'' + escapeAttr(nr.nodeId) + '\',\'' + escapeAttr(f.field) + '\')">Edit</button>';
        html += '<span class="spacer"></span>';
        html += '<button class="btn-danger-text" onclick="handleDiscardField(\'' + escapeAttr(nr.nodeId) + '\',\'' + escapeAttr(f.field) + '\')">Discard</button>';
      }
      html += '</div>';

      html += '</div>'; // .field-entry
    });
    html += '</div>'; // .node-card-body

    html += '</div>'; // .node-card
  });

  els.resultsList.innerHTML = html;
}

// ============================================================================
// Result Actions
// ============================================================================

function getFieldEntryEl(nodeId, field) {
  return document.getElementById('field-' + nodeId + '-' + field);
}

function getEditedDescription(nodeId, field) {
  var entry = getFieldEntryEl(nodeId, field);
  if (!entry) return null;
  var textarea = entry.querySelector('.field-edit-textarea');
  if (entry.classList.contains('editing') && textarea && textarea.value.trim()) {
    return textarea.value.trim();
  }
  // Fall back to the result data
  var nr = currentResults.find(function(r) { return r.nodeId === nodeId; });
  if (!nr) return null;
  var f = nr.fields.find(function(ff) { return ff.field === field; });
  return f ? f.description : null;
}

function handleApplyField(nodeId, field) {
  var description = getEditedDescription(nodeId, field);
  if (!description) {
    showError('Description cannot be empty.');
    return;
  }
  // Update the stored description if edited
  var nr = currentResults.find(function(r) { return r.nodeId === nodeId; });
  if (nr) {
    var f = nr.fields.find(function(ff) { return ff.field === field; });
    if (f) f.description = description;
  }
  sendToSandbox({ type: 'apply-field', nodeId: nodeId, field: field, description: description });
}

function handleEditField(nodeId, field) {
  var entry = getFieldEntryEl(nodeId, field);
  if (!entry) return;
  entry.classList.toggle('editing');
  if (entry.classList.contains('editing')) {
    var textarea = entry.querySelector('.field-edit-textarea');
    if (textarea) {
      textarea.focus();
      textarea.setSelectionRange(textarea.value.length, textarea.value.length);
    }
  }
}

function handleDiscardField(nodeId, field) {
  // Remove this field from the node result
  var nr = currentResults.find(function(r) { return r.nodeId === nodeId; });
  if (nr) {
    nr.fields = nr.fields.filter(function(f) { return f.field !== field; });
    // If no fields left, remove the entire node result
    if (nr.fields.length === 0) {
      currentResults = currentResults.filter(function(r) { return r.nodeId !== nodeId; });
    }
  }
  sendToSandbox({ type: 'discard-field', nodeId: nodeId, field: field });
  renderResults();
}

function handleDiscardNode(nodeId) {
  currentResults = currentResults.filter(function(r) { return r.nodeId !== nodeId; });
  sendToSandbox({ type: 'discard-node', nodeId: nodeId });
  renderResults();
}

function handleApplyNode(nodeId) {
  var nr = currentResults.find(function(r) { return r.nodeId === nodeId; });
  if (!nr) return;

  var pendingFields = [];
  nr.fields.forEach(function(f) {
    if (!isFieldApplied(nr.nodeId, f.field)) {
      var desc = getEditedDescription(nr.nodeId, f.field);
      if (desc) {
        f.description = desc;
        pendingFields.push({ field: f.field, description: desc });
      }
    }
  });

  if (pendingFields.length === 0) return;
  sendToSandbox({ type: 'apply-node', nodeId: nodeId, fields: pendingFields });
}

function handleApplyAll() {
  var nodes = [];
  currentResults.forEach(function(nr) {
    var pendingFields = [];
    nr.fields.forEach(function(f) {
      if (!isFieldApplied(nr.nodeId, f.field)) {
        var desc = getEditedDescription(nr.nodeId, f.field);
        if (desc) {
          f.description = desc;
          pendingFields.push({ field: f.field, description: desc });
        }
      }
    });
    if (pendingFields.length > 0) {
      nodes.push({ nodeId: nr.nodeId, fields: pendingFields });
    }
  });

  if (nodes.length === 0) return;
  sendToSandbox({ type: 'apply-all', nodes: nodes });
}

// ============================================================================
// PostMessage Communication
// ============================================================================

function sendToSandbox(message) {
  parent.postMessage({ pluginMessage: message }, '*');
}

window.onmessage = function(event) {
  var msg = event.data.pluginMessage;
  if (!msg) return;

  switch (msg.type) {
    case 'settings':
      populateSettings(msg.settings);
      break;

    case 'auto-generate':
      var source = msg.source === 'all-images' ? 'page' : 'selection';
      setTimeout(function() { handleGenerate(source); }, 100);
      break;

    case 'categories':
      // Categories created on the sandbox side — no UI action needed
      break;

    case 'status':
      setStatus(msg.message, isProcessing);
      break;

    case 'progress':
      if (msg.phase === 'exporting') {
        setStatus('Exporting image ' + msg.current + ' of ' + msg.total + '...', true);
        showProgress(msg.current, msg.total);
      } else if (msg.phase === 'polling') {
        setStatus('Waiting for results (attempt ' + msg.current + '/' + msg.total + ')...', true);
        showProgress(msg.current, msg.total);
      } else if (msg.phase === 'api-call') {
        setStatus('Sending to Visionati API...', true);
        showProgress(0, 1);
      }
      break;

    case 'results':
      setProcessing(false);
      currentResults = msg.results || [];
      appliedFields = {};

      var totalFields = 0;
      currentResults.forEach(function(nr) { totalFields += nr.fields.length; });
      var fieldNames = (msg.fields || []).map(function(f) { return FIELD_META[f] ? FIELD_META[f].label : f; });
      setStatus(
        totalFields + ' result' + (totalFields !== 1 ? 's' : '') +
        ' across ' + currentResults.length + ' image' + (currentResults.length !== 1 ? 's' : '') +
        ' (' + fieldNames.join(', ') + ')',
        false
      );

      renderResults();
      switchTab('results');
      break;

    case 'error':
      setProcessing(false);
      setStatus('Error', false);
      showError(msg.message);
      break;

    case 'field-applied':
      markFieldApplied(msg.nodeId, msg.field);
      renderResults();
      var pending = countPendingFields();
      if (pending === 0) {
        setStatus('All annotations applied!', false);
      } else {
        setStatus(pending + ' field' + (pending !== 1 ? 's' : '') + ' remaining', false);
      }
      break;

    case 'field-discarded':
      // Already handled in handleDiscardField
      break;

    case 'node-discarded':
      // Already handled in handleDiscardNode
      break;

    case 'all-applied':
      setProcessing(false);
      var parts = [];
      if (msg.applied > 0) parts.push('Applied to ' + msg.applied + ' image' + (msg.applied !== 1 ? 's' : ''));
      if (msg.failed > 0) parts.push(msg.failed + ' failed');
      setStatus(parts.join('. ') + '.', false);
      renderResults();
      break;
  }
};

// ============================================================================
// Utility Functions
// ============================================================================

function escapeHtml(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function escapeAttr(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ============================================================================
// Initialization
// ============================================================================

sendToSandbox({ type: 'load-settings' });

</script>
</body>
</html>